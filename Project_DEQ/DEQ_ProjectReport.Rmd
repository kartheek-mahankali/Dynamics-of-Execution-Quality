---
title: "Dynamics of Execution Quality"
author: "Sai Kartheek Mahankali"
date: "`r format(Sys.Date(), '%A, %B %d, %Y')`"
output:
  pdf_document:
    toc: true
    toc_depth: 2
    number_sections: true
    keep_tex: yes
    pandoc_args: ["-V", "geometry:a4paper"]
header-includes:
  - \usepackage{float}
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{helvet}
  - \usepackage{colortbl}
  - \renewcommand\familydefault{\sfdefault}
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.pos = "H")
```


```{r load_pkgs,results='hide'}
load.lib <- c(
  "weights", "kableExtra", "tidytext", "yaml", "config", "knitr", "formatR", "tibble", "dplyr", "tidyr", "lubridate", "ggplot2",
  "ggfortify", "caret", "tsibble", "fable", "fabletools", "feasts",
  "tsibbledata", "data.table", "xtable", "data.table", "rvest", "httr"
)

install.lib <- load.lib[!load.lib %in% installed.packages()]

for (lib in install.lib) {
  install.packages(lib, dependencies = TRUE)
}

sapply(load.lib, require, character = TRUE)
```


```{r load_functions_file}
source("C:/new_DEQ/functions.R")
```


```{r get_inputs_from_config_file}
config_file_path <- "C:/new_DEQ/config.yml"

get_input_from_config_file(config_file_path)

setwd(project_dir)
```

\newpage

# Abstract

A brokerage firm routes its orders to multiple market centers. Some of the reputed market centers are Citadel, Virtu Americas, and Jane Street. These market centers some times pay a fee to the brokerage firm for the opportunity to execute the trades. This is called payment for order flow (PFOF). As part of this project, we analyse the execution quality of the market centers which includes factors such as speed of execution, the likelihood of obtaining the best available price, minimization of price slippage, etc. We analyze multiple market centers to find which one of them provides better price improvement.

We use Rule 606 filings to understand the order routing, and Rule 605 filings of individual market centers to gather information on order execution quality. The net price improvement is calculated and the performance of individual market center is measured based on the weighted mean of net price improvement over the years.

\newpage

# Introduction

For any individual investor to purchase or sell stocks, the most convenient way is to open an online brokerage account with a reputable brokerage firm or an online trading platform (ex. Robinhood Securities, Interactive Brokers, etc.) For this project, we consider the example of Robinhood Securities, LLC. Once an individual investor places a buy or sell order with the brokerage firm, the order is routed to one of the market centers associated with the firm. Once the market center receives the order from the firm, it matches it with a corresponding order from another participant (Buy is matched will Sell and vice-versa) and executes the order. These market centers make money through the bid-ask spread, which is the difference between the buying price (bid) and selling price (ask) of a security. They earn a profit by buying securities at a slightly lower price than the market price and selling them at a slightly higher price.

## Rule 606

Broker-dealers that route client orders for equity and option securities are required by Rule 606 to produce quarterly reports that give a general overview of their routing procedures. This report makes order routing procedures measurable, encourages market participants to compete, and informs the public on how broker-dealers handle orders. Broker-dealers are also required to tell clients where their specific orders were sent upon request. Each client may ask for a free written copy of the report to be mailed to them. Each market center must report their order execution details, which is discussed in *Section 2.2*.


*Figure 1* shows the Robinhood Securities, LLC's rule 606 filing for January 2023 for S&P 500 stocks. We can observe that the huge proportion of orders placed with Robinhood have been routed to Virtu Americas LLC (51.51%) and CITADEL Securities LLC (25.61%), followed by G1 Execution Services LLC (11.37%) and Jane Street Capital (10.06%)

```{r img1, fig.cap="Robinhood Rule 606 filing for January 2023", fig.pos="H", out.width="100%", echo=FALSE}
image_path <- paste0(project_dir, "/rh606.PNG")
knitr::include_graphics(image_path)
```


## Rule 605

According to **[FINRA](https://www.finra.org/rules-guidance/guidance/sec-rule-605#:~:text=Rule%2011Ac1%2D5%20is%20aimed,to%20make%20monthly%20electronic%20reports.)**, the Exchange Act Rule 11Ac1-5 was adopted by the SEC in November 2000. The purpose of Rule 11Ac1-5 is to enhance order execution quality disclosure to the general public. The SEC requires market centers that trade securities on the national market system to submit monthly electronic reports in accordance with Rule 11Ac1-5. These reports contain details about the execution quality at each market center on a stock-by-stock basis, including how market orders of different sizes are carried out in relation to the open quotes. These reports are required to include information on effective spreads, or the spreads that investors who route their orders to a specific market center actually pay. Market centers must also disclose the extent to which they offer investors employing limit orders executions at prices superior to the public quotes.
As per **[SEC](https://www.sec.gov/interps/legal/slbim12a.htm#P30_1565)**, the Rule instructed the self-regulatory organizations ('SROs') that trade national market system securities to collaborate and submit to the Commission a new national market system plan (the 'Joint-SRO Plan') establishing procedures for market centers to follow in making their monthly reports available to the public.

The Joint-SRO Plan states that the rule 605 filing has 26 fields as below:

1. **Designated Participant:** The designated participant refers to an entity that engages in trading activities within a specific market. It can be a broker-dealer, market center, or any other entity involved in executing orders. The Participant identification codes are as follows: Amex - "A"; BSE - "B"; CHX - "M"; CSE - "C"; NASD - "T"; NYSE - "N"; PCX - "P"; Phlx - "X".

2. **Market Center Code:** A market center is a venue or platform where trading takes place. It can be an exchange, electronic communication network (ECN), or other trading systems. The market center code is assigned by a Designated Participant.

3. **Month and Year:** Date refers to the specific day or time period for which the data in the Rule 605 filing is being reported. It indicates when the trading activity took place. The report shows it as a six digit code in the format "yyyymm".

4. **Ticker Symbol:** Ticker represents the unique symbol or abbreviation used to identify a particular security or financial instrument. It is commonly used to represent the traded instrument's name in stock exchanges or financial markets. 

5. **Order Type:** Order type specifies the instructions given by an investor or trader when placing an order to buy or sell a security. The order type codes are as follows: market orders - "11"; marketable limit orders - "12"; inside-the-quote limit orders - "13"; at-the-quote limit orders - "14"; near-the-quote limit orders - "15".

6. **Order Size** Order size refers to the quantity or volume of shares or contracts specified in an order to buy or sell a security. It indicates the number of units the investor or trader wishes to transact. The order size codes are as follows: 100-499 shares - "21"; 500-1999 shares - "22"; 2000-4999 shares - "23"; 5000 or more shares - "24".

7. **Total Covered Orders:** Total covered orders represent the overall number of orders placed by participants during the specified period.

8. **Total Covered Shares:** Total shares represent the total volume or quantity of shares involved in the orders placed by participants during the specified period.

9. **Cancelled Shares:** Cancelled shares refer to the volume or quantity of shares that were initially part of an order but were later canceled by the participant before execution.

10. **Market Center Executed Shares:** Market center executed shares represents the cumulative number of shares of covered orders executed at the receiving market center.

11. **Away Executed Shares:** Away executed shares represent the cumulative number of shares of covered orders executed at any other venue.

12. **Shares from 0 to 9 Seconds:** It represents the cumulative number of shares of covered orders executed from 0 to 9 seconds after the time of order receipt.

13. **Shares from 10 to 29 Seconds:** It represents the cumulative number of shares of covered orders executed from 10 to 29 seconds after the time of order receipt.

14. **Shares from 30 to 59 Seconds:** It represents the cumulative number of shares of covered orders executed from 30 to 59 seconds after the time of order receipt.

15. **Shares from 60 to 299 Seconds:** It represents the cumulative number of shares of covered orders executed from 60 to 299 seconds after the time of order receipt.

16. **Shares from 5 to 30 Minutes:** It represents the cumulative number of shares of covered orders executed from 5 to 30 minutes after the time of order receipt.

17. **Average Realized Spread:** Average realized spread refers to the average difference between the execution price of a trade and the midpoint of the National Best Bid and Offer (NBBO) at the time of trade. It provides an indication of the cost or benefit associated with executing trades. It is expressed in dollars carried out to 4 decimal places.

18. **Average Effective Spread:** Average effective spread represents the average difference between the execution price of a trade and the prevailing market price at the time of trade. It considers the impact of market liquidity on the transaction's cost. It is expressed in dollars carried out to 4 decimal places.

19. **Price Improved Shares:** Price improved shares represent the volume or quantity of shares that were executed at prices better than the National Best Bid and Offer (NBBO) midpoint.

20. **Price Improved Avg Amount:** For shares executed with price improvement, it is the share-weighted average amount per share that prices were improved. The amount shall be expressed in dollars and carried out to four decimal places.

21. **Price Improved Avg Time (Secs):** For shares executed with price improvement, it is the share-weighted average period from the time of order receipt to the time of order execution. The period shall be expressed in number of seconds and carried out to one decimal place.

22. **At-the-Quote Shares:** At the quote shares represents the cumulative number of shares of covered orders executed at the quote.

23. **At-the-Quote Avg Time (Secs):** For shares executed at the quote, it is the share-weighted average period of time from the time of order receipt to the time of order execution. The period shall be expressed in number of seconds and carried out to one decimal place.

24. **Outside-the-Quote Shares:** Outside the quote shares represents the cumulative number of shares of covered orders executed outside the quote.

25. **Outside-the-Quote Avg Amount($):** For shares executed outside the quote, it is the share-weighted average amount per share that prices were outside the quote. The amount shall be expressed in dollars and carried out to four decimal places.

26. **Outside-the-Quote Avg Time (Secs):** For shares executed outside the quote, it is the share-weighted average period of time from the time of order receipt to the time of order execution. The period shall be expressed in number of seconds and carried out to one decimal place.

# Evaluating a market center

When assessing the performance of a market center, there are several factors to consider. According to [Fidelity Capital Markets](https://capitalmarkets.fidelity.com/trade-execution-quality), below are the key metrics in evaluating a market center based on the trade execution quality:

1. **Price Improvement:** It is measured as the percentage of shares executed at prices better than the prevailing National Best Bid or Offer (NBBO). That is, either below the best offer for buy orders or above the best bid for sell orders.

2. **Execution Price:** It is measured as the percentage of shares executed at or within the National Best Bid or Offer (NBBO) for a security across all exchanges and/or market centers.

3. **Execution Speed:** It is the average time taken from the order reception by the market center to the order execution by the market center.

4. **Effective Spread:** It is the average difference between the execution price of a trade and the prevailing market price at the time of trade. This amount captures both how often, and by how much, a broker-dealer improves the price of a share.


It's important to note that assessing the performance of market centers can be challenging for individual traders as some performance metrics and data may not be readily available. In such cases, it can be helpful to rely on industry reports, reviews, and insights from reputable sources to gauge the market center's performance.

This project primarily deals with analyzing and understanding the dynamics of order execution quality based on the data from rule 605 filings.

\newpage

# Input Parameters

Below is the input configuration file (config.yml) which allows the user to provide the working directory for the project along with order sizes, order types, tickers, and market center IDs to be considered for analysis.

```{r print_config_file}
configfile <- readLines(config_file_path)

cat(configfile, sep = "\n")
```

\newpage

# Data Collection and Pre-processing

Rule 605 filing is done every month, which means we have to look at 12 different filings to understand and evaluate the performance of a market center based on most recent data. For this project, we chose to consider at least 4 years of historical data for each market center to fairly evaluate its order execution quality. The files can be downloaded in either *.dat* or *.txt* formats.

## Step 1: Collect the data

*Table 1* shows various market centers along with their IDs and URLs to download the latest rule 605 filings available on their respective websites.

```{r market_center_table,results = 'asis',fig.pos="H", tidy=FALSE}

mctable_file_path <- paste0(project_dir,"/data/constituent_data/mcid.csv")

market_center_table <- fread(mctable_file_path)
market_center_table %>% 
  knitr::kable(
    format = "latex",
    booktabs = TRUE,
    longtable = TRUE,
    caption = "Market Centers and URLs to download Rule 605 filings",
    linesep = "",
    align = "l"
    ) %>%
  kableExtra::kable_styling(
      position = "left",
      latex_options = c("striped", "repeat_header", "HOLD_position"),
      stripe_color = "gray!15",
      font_size = 7
    ) %>%
  kableExtra::row_spec(0,bold = TRUE)
```

```{r print_input_values}
# Market center mapping

if (length(mcid_list) > 0) {
  mc_name_vector <- character()

  for (mc in mcid_list) {
    mc_name <- market_center_table$mc_name[market_center_table$mc_id == mc]

    if (length(mc_name) > 0) {
      mc_name_vector <- c(mc_name_vector, mc_name)
    }
  }
}

# Order size and Order type mapping
ordersize <- case_when(
  order_size_ip == 21 ~ "100-499",
  order_size_ip == 22 ~ "500-1999",
  order_size_ip == 23 ~ "2000-4999",
  order_size_ip == 24 ~ "5000+",
  TRUE ~ NA_character_
)

ordertype <- case_when(
  order_type_ip == 11 ~ "mkt_ordr",
  order_type_ip == 12 ~ "mktbl_lmt_ordr",
  order_type_ip == 13 ~ "insd_qt_lmt_ordr",
  order_type_ip == 14 ~ "at_qt_lmt_ordr",
  order_type_ip == 15 ~ "nr_qt_lmt_ordr",
  TRUE ~ NA_character_
)
```

We use the URLs above to download the past 4 years' rule 605 filings for the list of market centers provided in the configuration file. From the configuration file in *Section 4*, we see that the list of market center IDs to be analysed are `r mcid_list` which correspond to the market centers - `r mc_name_vector`. The chosen order size is `r order_size_ip` which translates to `r ordersize` and order type is `r order_type_ip` which translates to `r ordertype`.

The user can either manually download the rule 605 filings for the chosen market centers or run the "download_rule605_filings.R" file to automatically download all the available filings from the respective URLs.

```{r get_rule605_files, echo=TRUE, results='hide'}
```

The Joint-SRO Plan requires that the market centers publish their monthly reports in the form of electronic data files (standard, pipe-limited ASCII files). Top 5 lines of a rule 605 filing is as shown below:

```{r print_5lines,echo=TRUE, results='asis',tidy=TRUE, tidy.opts=list(width.cutoff=50),out.width=50}
file_path <- paste0(project_dir, "/data/f605_data")
file_name <- list.files(file_path, recursive = TRUE)[1]
rule605_file <- file.path(file_path, file_name)
file_content <- readLines(rule605_file, n = 5)

# Add a new line for better readability

rows <- ""
for (line in file_content) {
  rows <- paste(rows, line, "\n", sep = "\n")
}
cat(rows)
```

Read the downloaded rule 605 filings (.txt or .dat files) of each market center, to which the orders are routed by the broker. The list of market centers to be considered is given by the broker's rule 606 filing. Combine the data into a data frame (table) with relevant column names for ease of analysis and readability. The structure of the data frame reflects that of the rule 605 filing where in each row corresponds to the monthly orders for a given ticker.

```{r read_rule605_files, echo=TRUE}
rule605_path <- paste0(project_dir, "/data/f605_data")

setwd(rule605_path)

rule605_files <- list.files(rule605_path, recursive = TRUE)

rule605_col_names <- c(
  "participant", "market_center", "date",
  "ticker", "order_type", "order_size",
  "total_orders", "total_shrs", "cancelled_shrs",
  "mc_exec_shrs", "away_exec_shrs", "shrs_0to9sec",
  "shrs_10to29sec", "shrs_30to59sec", "shrs_60to299sec",
  "shrs_5to30min", "avg_realzd_spread", "avg_effec_spread",
  "px_improved_shrs", "px_improved_avg_amt", "px_improved_avg_secs",
  "at_quote_shrs", "at_quote_avg_secs", "outside_quote_shrs",
  "outside_quote_avg_amt", "outside_quote_avg_sec"
)

rule605_col_types <- c(
  "character", "character", "character",
  "character", "character", "character",
  "numeric", "numeric", "numeric",
  "numeric", "numeric", "numeric",
  "numeric", "numeric", "numeric",
  "numeric", "numeric", "numeric",
  "numeric", "numeric", "numeric",
  "numeric", "numeric", "integer",
  "numeric", "numeric"
)

rule605_all <- process_rule605_files(rule605_files, rule605_col_names, rule605_col_types)
```

## Step 2: Add listing information as new columns

We add five new columns to the data frame namely - in_sp500, in_r1000, on_nyse, on_nasdaq, on_amex. For each row, based on the corresponding ticker listing, these columns will be marked either "TRUE" or "FALSE".

```{r get_constituent_data, echo=TRUE}
constituent_data_dir <- paste0(project_dir, "/data/constituent_data")

setwd(constituent_data_dir)

rule605_all <- add_listing_data(rule605_all, "sp500constituents.csv", "in_sp500")
rule605_all <- add_listing_data(rule605_all, "russell1000_constituents.csv", "in_r1000")
rule605_all <- add_listing_data(rule605_all, "tickers_NYSE.csv", "on_nyse")
rule605_all <- add_listing_data(rule605_all, "tickers_NASDAQ.csv", "on_nasdaq")
rule605_all <- add_listing_data(rule605_all, "tickers_AMEX.csv", "on_amex")
```

## Step 3: Filter the data frame based on user input

The data frame is filtered based on the order type and order size chosen by the user in configuration file.  

```{r filter_rule605, echo=TRUE}
rule605_df <- rule605_all %>%
  filter(order_type %in% order_type_ip) %>%
  filter(order_size %in% order_size_ip) %>%
  filter(mc_exec_shrs != 0)

rule605_df[is.na(rule605_df)] <- 0
```

We make the below updates to the data frame:

1. order_type and order_size codes are translated to their respective descriptions based on the mapping provided in the configuration file.

2. A new column total_exec_shrs is added as the sum of mc_exec_shrs and away_exec_shrs.

```{r update_rule605_df}
rule605_df <- update_rule605_df(rule605_df)
```

*Table 2* shows sample rows and columns from the updated data frame rule605_df.

```{r,results = 'asis',fig.pos="H", tidy=FALSE}

library(lubridate)

sample_df <- rule605_df %>%
  select(2:6, 17,18) %>%
  sample_n(5) %>%
  arrange(market_center)

sample_df$date <- as.Date(paste0(substr(sample_df$date, 1, 4), "-", substr(sample_df$date, 5, 6), "-01"))

sample_df$date <- format(sample_df$date, "%Y %b")

```

```{r,results = 'asis',fig.pos="H", tidy=FALSE}
sample_df %>% 
  knitr::kable(
    format = "latex",
    booktabs = TRUE,
    longtable = FALSE,
    caption = "Sample rows and columns from the data frame",
    linesep = "",
    align = "l"
    ) %>%
  kableExtra::kable_styling(
      position = "left",
      latex_options = c("striped", "repeat_header", "scale_down", "HOLD_position"),
      stripe_color = "gray!15"
    ) %>%
  kableExtra::row_spec(0,bold = TRUE)

```

# Calculation of Net Price Improvement

**Net price improvement** refers to the overall benefit obtained by a trader or investor when executing trades. It is calculated by considering the difference between the execution prices achieved and the prevailing market prices at the time of trade.

In the context of trading, price improvement occurs when a trade is executed at a better price than the prevailing market price. It can be achieved by executing at prices better than the National Best Bid and Offer (NBBO) or by obtaining more favorable execution prices compared to the midpoint of the NBBO.

Net price improvement takes into account both positive and negative price improvements. Positive price improvement occurs when trades are executed at prices better than the prevailing market price, resulting in cost savings or additional gains for the trader. On the other hand, negative price improvement occurs when trades are executed at prices worse than the prevailing market price, resulting in additional costs or losses for the trader.

By calculating the net price improvement, traders can evaluate the overall impact of their execution quality. It provides a measure of how effectively trades are executed in terms of obtaining better prices compared to the prevailing market conditions. Positive net price improvement indicates that the trader achieved better prices overall, while negative net price improvement suggests that the trader experienced worse prices on average compared to the market.

Net price improvement is an important metric for assessing execution quality, especially when evaluating the performance of market centers, brokers, or trading algorithms. It helps traders and investors analyze the impact of execution decisions and identify opportunities to improve trading strategies and outcomes.

Below is how we calculate the net price improvement per ticker:

**(px_improved_shrs * px_improved_avg_amt):** This calculates the total value of price improvement for the shares that were executed at better prices than the NBBO midpoint.

**(outside_quote_shrs * outside_quote_avg_amt):** This calculates the total value of price deviation for the shares executed at prices outside the NBBO quote.

**((px_improved_shrs * px_improved_avg_amt) - (outside_quote_shrs * outside_quote_avg_amt)):** This calculates the net value improvement by summing the value of price improvements and subtracting the value of price deviations.

we multiply the value by 100 to convert the value into cents from dollars. Let us call it **net_pi_numerator**.

we divide the net_pi_numerator value by the total number of shares executed to get the net price improvement per ticker value.

Hence, the formula we use to calculate the net price improvement is:

**net_pi_numerator/total_exec_shrs**

*Table 3* shows the sample rows from the data frame along with the net_pi column

```{r row_level_net_pi}
# Create the row level net_pi_numerator

rule605_df <- rule605_df %>%
  mutate(net_pi_numerator = 100 * ((px_improved_shrs * px_improved_avg_amt) +
    (at_quote_shrs * 0) - (outside_quote_shrs *
      outside_quote_avg_amt)))

# For a row level weighted net-pi, divide the net_pi_numerator by all executed shares in the row.

rule605_df <- rule605_df %>%
  mutate(net_pi = round(net_pi_numerator / total_exec_shrs, 3))
```

```{r,results = 'asis',fig.pos="H", tidy=FALSE}

sample_df <- rule605_df %>%
  select(2:6,31,30,32) %>%
  sample_n(5) %>%
  arrange(market_center)

sample_df$date <- as.Date(paste0(substr(sample_df$date, 1, 4), "-", substr(sample_df$date, 5, 6), "-01"))

sample_df$date <- format(sample_df$date, "%Y %b")

sample_df %>% 
  knitr::kable(
    format = "latex",
    booktabs = TRUE,
    longtable = FALSE,
    caption = "Sample rows and columns from the data frame",
    linesep = "",
    align = "l"
    ) %>%
  kableExtra::kable_styling(
      position = "left",
      latex_options = c("striped", "repeat_header", "scale_down", "HOLD_position"),
      stripe_color = "gray!15"
    ) %>%
  kableExtra::row_spec(0,bold = TRUE)

```

# Weighted-Mean & Weighted-Median of Net Price Improvement

Weighted mean and median of net price improvement are commonly used measures to evaluate the execution quality of a market maker or trading strategy. Using weighted mean and median allows for the consideration of trade sizes or volumes. This is important because larger trades may have a greater impact on the overall execution quality, and assigning weights based on trade sizes helps reflect this influence. 

**Weighted mean** provides an average net price improvement, taking into account the relative importance of each trade based on their weights (e.g., trade size or executed shares). It represents the average improvement achieved across all trades, giving more weight to larger trades.
The weighted mean of the net price improvement is calculated using the below formula

**wtd.mean(net_pi, total_exec_shrs)**

**Weighted median** represents the middle value of the net price improvement when sorted in ascending order, considering the weights. It is a measure that is less affected by extreme values and provides insight into the typical or representative net price improvement.
The weighted median of the net price improvement is calculated using the below formula

**wtd.quantile(net_pi, total_exec_shrs , probs= 0.5)**


```{r calc_wmean}
# weighted mean net_pi per market center,order type, and order size
net_pi_wmean <- rule605_df %>%
  group_by(market_center, order_type, order_size) %>%
  summarise(net_pi_wmean = round(wtd.mean(net_pi, total_exec_shrs), 3))

# weighted mean net_pi per market center and month
net_pi_monthly_wmean <- rule605_df %>%
  group_by(market_center, date) %>%
  summarise(net_pi_wmean = round(wtd.mean(net_pi, total_exec_shrs), 3))

# weighted mean net_pi per market center and ticker

if (length(ticker_list) > 0) {
  filtered_df <- rule605_df %>%
    filter(ticker %in% ticker_list)

  net_pi_ticker_wmean <- filtered_df %>%
    group_by(market_center, ticker) %>%
    summarise(net_pi_wmean = round(wtd.mean(net_pi, total_exec_shrs), 3))
}


# weighted mean net_pi for stocks based on S&P 500 listing
net_pi_sp500_wmean <- rule605_df %>%
  group_by(market_center, in_sp500) %>%
  summarise(net_pi_wmean = round(wtd.mean(net_pi, total_exec_shrs), 3))

# weighted mean net_pi for stocks based on Russell 1000 listing
net_pi_r1000_wmean <- rule605_df %>%
  group_by(market_center, in_r1000) %>%
  summarise(net_pi_wmean = round(wtd.mean(net_pi, total_exec_shrs), 3))

# weighted mean net_pi for stocks based on NYSE listing
net_pi_nyse_wmean <- rule605_df %>%
  group_by(market_center, on_nyse) %>%
  summarise(net_pi_wmean = round(wtd.mean(net_pi, total_exec_shrs), 3))

# weighted mean net_pi for stocks based on NASDAQ listing
net_pi_nsdq_wmean <- rule605_df %>%
  group_by(market_center, on_nasdaq) %>%
  summarise(net_pi_wmean = round(wtd.mean(net_pi, total_exec_shrs), 3))

# weighted mean net_pi for stocks based on AMEX listing
net_pi_amex_wmean <- rule605_df %>%
  group_by(market_center, on_amex) %>%
  summarise(net_pi_wmean = round(wtd.mean(net_pi, total_exec_shrs), 3))
```

```{r calc_wmed}
# weighted median net_pi per market center, order type, and order_size
net_pi_wmed <- rule605_df %>%
  group_by(market_center, order_type, order_size) %>%
  summarise(net_pi_wmed = round(wtd.quantile(net_pi, total_exec_shrs, probs = 0.5), 3))

# weighted median net_pi per market center and month
net_pi_monthly_wmed <- rule605_df %>%
  group_by(market_center, date) %>%
  summarise(net_pi_wmed = round(wtd.quantile(net_pi, total_exec_shrs, probs = 0.5), 3))

# weighted median net_pi per market center and ticker

if (length(ticker_list) > 0) {
  filtered_df <- rule605_df %>%
    filter(ticker %in% ticker_list)

  net_pi_ticker_wmed <- filtered_df %>%
    group_by(market_center, ticker) %>%
    summarise(net_pi_wmed = round(wtd.quantile(net_pi, total_exec_shrs, probs = 0.5), 3))
}

# weighted median net_pi for stocks based on S&P 500 listing
net_pi_sp500_wmed <- rule605_df %>%
  group_by(market_center, in_sp500) %>%
  summarise(net_pi_wmed = round(wtd.quantile(net_pi, total_exec_shrs, probs = 0.5), 3))

# weighted median net_pi for stocks based on Russell 1000 listing
net_pi_r1000_wmed <- rule605_df %>%
  group_by(market_center, in_r1000) %>%
  summarise(net_pi_wmed = round(wtd.quantile(net_pi, total_exec_shrs, probs = 0.5), 3))

# weighted median net_pi for stocks based on NYSE listing
net_pi_nyse_wmed <- rule605_df %>%
  group_by(market_center, on_nyse) %>%
  summarise(net_pi_wmed = round(wtd.quantile(net_pi, total_exec_shrs, probs = 0.5), 3))

# weighted median net_pi for stocks based on NASDAQ listing
net_pi_nsdq_wmed <- rule605_df %>%
  group_by(market_center, on_nasdaq) %>%
  summarise(net_pi_wmed = round(wtd.quantile(net_pi, total_exec_shrs, probs = 0.5), 3))

# weighted median net_pi for stocks based on AMEX listing
net_pi_amex_wmed <- rule605_df %>%
  group_by(market_center, on_amex) %>%
  summarise(net_pi_wmed = round(wtd.quantile(net_pi, total_exec_shrs, probs = 0.5), 3))
```

```{r calc_weighted_quantiles}
rule605_size_wq <- get_weighted_quantiles_per_size(rule605_df, ordertype, ordersize)

rule605_type_wq <- get_weighted_quantiles_per_type(rule605_df, ordertype, ordersize)
```

```{r merge_tables}
# Merge the weighted mean and weighted median tables for all combinations

net_pi_amex <- inner_join(net_pi_amex_wmean, net_pi_amex_wmed, by = c("market_center", "on_amex")) %>% arrange(market_center)

net_pi_nyse <- inner_join(net_pi_nyse_wmean, net_pi_nyse_wmed, by = c("market_center", "on_nyse")) %>% arrange(market_center)

net_pi_nsdq <- inner_join(net_pi_nsdq_wmean, net_pi_nsdq_wmed, by = c("market_center", "on_nasdaq")) %>% arrange(market_center)

net_pi_sp500 <- inner_join(net_pi_sp500_wmean, net_pi_sp500_wmed, by = c("market_center", "in_sp500")) %>% arrange(market_center)

net_pi_r1000 <- inner_join(net_pi_r1000_wmean, net_pi_r1000_wmed, by = c("market_center", "in_r1000")) %>% arrange(market_center)

net_pi_vals <- inner_join(net_pi_wmean, net_pi_wmed, by = c("market_center", "order_type", "order_size")) %>% arrange(market_center)

net_pi_monthly <- inner_join(net_pi_monthly_wmean, net_pi_monthly_wmed, by = c("market_center", "date")) %>% arrange(market_center)


if (!is.null(net_pi_ticker_wmean) && !is.null(net_pi_ticker_wmed)) {
  net_pi_ticker <- inner_join(net_pi_ticker_wmean, net_pi_ticker_wmed, by = c("market_center", "ticker")) %>%
    arrange(market_center)
}
```


*Table 4* shows the overall weighted mean and weighted median of net price improvement for each market center.


```{r net_pi_tables1,results = 'asis',fig.pos="H", tidy=FALSE}

if (!is.null(net_pi_ticker)) {
  
  net_pi_ticker %>% 
    knitr::kable(
  format = "latex",
  booktabs = TRUE,
  longtable = FALSE,
  caption = "W-Mean and W-Median of Net Price Improvement by Ticker",
  linesep = "",
  align = "l"
  ) %>%
kableExtra::kable_styling(
    position = "left",
    latex_options = c("striped", "repeat_header", "scale_down", "HOLD_position"),
    stripe_color = "gray!15",
    font_size = 4
  ) %>%
kableExtra::row_spec(0,bold = TRUE)
} else {

  net_pi_monthly %>% 
  knitr::kable(
    format = "latex",
    booktabs = TRUE,
    longtable = FALSE,
    caption = "W-Mean and W-Median of Net Price Improvement by Month",
    linesep = "",
    align = "l"
    ) %>%
  kableExtra::kable_styling(
      position = "left",
      latex_options = c("striped", "repeat_header", "scale_down", "HOLD_position"),
      stripe_color = "gray!15",
      font_size = 4
    ) %>%
  kableExtra::row_spec(0,bold = TRUE)
}


```


*Table 5* shows the weighted mean and weighted median of net price improvement for each market center, grouped by order size and order type.

```{r net_pi_tables2,results = 'asis',fig.pos="H", tidy=FALSE}

net_pi_vals %>% 
knitr::kable(
  format = "latex",
  booktabs = TRUE,
  longtable = FALSE,
  caption = "W-Mean and W-Median of Net Price Improvement by Order Type and Order Size",
  linesep = "",
  align = "l"
  ) %>%
kableExtra::kable_styling(
    position = "left",
    latex_options = c("striped", "repeat_header", "scale_down", "HOLD_position"),
    stripe_color = "gray!15",
    font_size = 4
  ) %>%
kableExtra::row_spec(0,bold = TRUE)


```

## W-Mean & W-Median of Net PI by Ticker Listing

We calculate the weighted mean and weighted median of net price improvement for each market center based on listing of the executed stocks in S&P 500, Russell 1000, New York Stock Exchange, NASDAQ, and AMEX.

### By S&P 500 listing

*Table 6* shows the weighted mean and weighted median of net price improvement for various market centers based on the ticker listing in S&P 500. 

```{r net_pi_sp500,results = 'asis',fig.pos="H", tidy=FALSE}

net_pi_sp500 %>% 
  knitr::kable(
    format = "latex",
    booktabs = TRUE,
    longtable = FALSE,
    caption = "W-Mean and W-Median of Net Price Improvement by SP500 Listing",
    linesep = "",
    align = "l"
    ) %>%
  kableExtra::kable_styling(
      position = "left",
      latex_options = c("striped", "repeat_header", "scale_down", "HOLD_position"),
      stripe_color = "gray!15",
      font_size = 4
    ) %>%
  kableExtra::row_spec(0,bold = TRUE)
```

### By Russell 1000 listing

*Table 7* shows the weighted mean and weighted median of net price improvement for various market centers based on the ticker listing in Russell 1000.

```{r net_pi_r1000,results = 'asis',fig.pos="H", tidy=FALSE}

net_pi_r1000 %>% 
  knitr::kable(
    format = "latex",
    booktabs = TRUE,
    longtable = FALSE,
    caption = "W-Mean and W-Median of Net Price Improvement by Russell 1000 Listing",
    linesep = "",
    align = "l"
    ) %>%
  kableExtra::kable_styling(
      position = "left",
      latex_options = c("striped", "repeat_header", "scale_down", "HOLD_position"),
      stripe_color = "gray!15",
      font_size = 4
    ) %>%
  kableExtra::row_spec(0,bold = TRUE)

```

### By New York Stock Exchange listing

*Table 8* shows the weighted mean and weighted median of net price improvement for various market centers based on the ticker listing on New York Stock Exchange.

```{r net_pi_nyse,results = 'asis',fig.pos="H", tidy=FALSE}

net_pi_nyse %>% 
  knitr::kable(
    format = "latex",
    booktabs = TRUE,
    longtable = FALSE,
    caption = "W-Mean and W-Median of Net Price Improvement by NYSE Listing",
    linesep = "",
    align = "l"
    ) %>%
  kableExtra::kable_styling(
      position = "left",
      latex_options = c("striped", "repeat_header", "scale_down", "HOLD_position"),
      stripe_color = "gray!15",
      font_size = 4
    ) %>%
  kableExtra::row_spec(0,bold = TRUE)

```

### By NASDAQ listing

*Table 9* shows the weighted mean and weighted median of net price improvement for various market centers based on the ticker listing on NASDAQ.

```{r net_pi_nsdq,results = 'asis',fig.pos="H", tidy=FALSE}
net_pi_nsdq %>% 
  knitr::kable(
    format = "latex",
    booktabs = TRUE,
    longtable = FALSE,
    caption = "W-Mean and W-Median of Net Price Improvement by NASDAQ Listing",
    linesep = "",
    align = "l"
    ) %>%
  kableExtra::kable_styling(
      position = "left",
      latex_options = c("striped", "repeat_header", "scale_down", "HOLD_position"),
      stripe_color = "gray!15",
      font_size = 4
    ) %>%
  kableExtra::row_spec(0,bold = TRUE)

```


# Time Series of Weighted Mean of net price improvement

We plot the weighted mean of net price improvement for each market maker as a time series to analyze and evaluate which market maker has been consistently performing better than the others in terms of order execution quality and net price improvement. 

```{r mc_wmean, echo=TRUE}
# Use the net pi per month for each market center

net_pi_monthly_wmean$date <- as.Date(paste0(
  substr(net_pi_monthly_wmean$date, 1, 4), "-",
  substr(net_pi_monthly_wmean$date, 5, 6), "-01"
))
net_pi_monthly_wmean <- net_pi_monthly_wmean %>%
  distinct() %>%
  mutate(date = yearmonth(date))

net_pi_monthly_wmean <- net_pi_monthly_wmean %>%
  as_tsibble(key = market_center, index = date)

# Plot the data

autoplot(net_pi_monthly_wmean) + labs(x = "Month-Year", y = "Weighted Mean")
```

*Table 10* shows which market maker has achieved the highest weighted mean of net price improvement for each month.

```{r max_wmean table,results = 'asis',fig.pos="H", tidy=FALSE}

mc_wmean <-rule605_df %>%
  group_by(market_center,date) %>%
  summarise(mc_wmean = round(wtd.mean(net_pi, total_exec_shrs, na.rm = TRUE), 2))


max_wmean <- mc_wmean %>%
  group_by(date) %>%
  top_n(1, mc_wmean) %>%
  ungroup() %>%
  select(date, market_center,mc_wmean) %>%
  distinct() %>%
  arrange(date)

max_wmean$date <- as.Date(paste0(substr(max_wmean$date, 1, 4), "-", substr(max_wmean$date, 5, 6), "-01"))

max_wmean <- max_wmean %>%
  distinct() %>%
  mutate(date = yearmonth(date))

max_wmean <- max_wmean %>%
  as_tsibble(key = market_center, index = date)


max_wmean <- max_wmean %>% arrange(date)
max_wmean$date <- format(max_wmean$date, "%Y %b")


max_wmean %>% 
  knitr::kable(
    format = "latex",
    booktabs = TRUE,
    longtable = TRUE,
    caption = "Highest W-mean of Net PI per month",
    linesep = "",
    align = "l"
    ) %>%
  kableExtra::kable_styling(
      position = "left",
      latex_options = c("striped", "repeat_header", "HOLD_position"),
      stripe_color = "gray!15"
    ) %>%
  kableExtra::row_spec(0,bold = TRUE)

```


```{r sessionInfo, echo=TRUE, results='markup', out.width="60%"}
# Below are the version details

print(sessionInfo(), locale = FALSE)
```
